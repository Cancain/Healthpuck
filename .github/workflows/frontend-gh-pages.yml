name: Deploy frontend to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch: {}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps (update lockfile if needed)
        run: npm install --no-audit --no-fund

      - name: Build
        env:
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
        run: npm run build

      - name: Deploy to main/docs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Preserve CNAME file if it exists (backup outside docs/ to survive deletion)
          if [ -f docs/CNAME ]; then
            cp docs/CNAME CNAME.bak
          elif [ -f CNAME ]; then
            # If CNAME exists in root (created by GitHub), preserve it
            cp CNAME CNAME.bak
          fi

          # Remove existing docs directory if it exists
          rm -rf docs

          # Copy build to docs
          cp -r build docs

          # Create .nojekyll file to disable Jekyll processing
          touch docs/.nojekyll

          # Restore or create CNAME file for custom domain
            cp CNAME.bak docs/CNAME
            rm CNAME.bak
            mv docs/CNAME.bak docs/CNAME
          else
            echo "app.healthpuck.se" > docs/CNAME
          fi

          # Commit and push (skip hooks since these are build artifacts)
          git add docs/.nojekyll
          git add docs/CNAME
          git add docs
          if git diff --staged --quiet; then
            echo "No changes to deploy"
          else
            git commit --no-verify -m "Deploy to docs [skip ci]"
            git push origin main
          fi
